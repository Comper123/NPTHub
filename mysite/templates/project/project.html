{% extends 'base.html' %}

{% load static %}

{%block title %}PicHub{% endblock %}

{% block head %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{% static 'css/project/project.css' %}">
    <!-- Подключаем ajax -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        // Обработка лайка и дизлайка комментария
        function likeComment(id, csrf){
            $.ajax({
                url: "/project_ajax/",
                type: "POST",
                data: {
                    'autor_name': '{{ project.autor.username }}',
                    'project_name': '{{ project.name }}',
                    'comment': id,
                    'action': $(this).hasClass("unlike_comment_btn")?'like_comment':'unlike_comment',
                    'csrfmiddlewaretoken': csrf,
                },
                success: function(response) {
                    $(this).find("p").text(response.text);  // Update the page dynamically
                    if (!$(this).hasClass("unlike_comment_btn")){
                        $(this).addClass("unlike_comment_btn");
                        $(this).find("i").removeClass("heart_checked");
                        $(this).find("i").removeClass("fa-solid");
                        $(this).find("i").addClass("fa-regular");
                    } else {
                        $(this).removeClass("unlike_comment_btn");
                        $(this).find("i").addClass("heart_checked");
                        $(this).find("i").removeClass("fa-regular");
                        $(this).find("i").addClass("fa-solid");
                    }
                }
            });
            }
    </script>
{% endblock %}

{% block content %}
    <main>
        <div class="project_info">
            <div class="projname">
                <a href="{% url 'profile' project.autor.username %}">
                    <img src="/media/{{ project.autor.profile.photo }}" alt="">
                </a>
                <h2 class="project_autor">{{ project.autor.username }}</h2>
                <h2>/</h2>
                <h2 class="project_name">{{ project.name }}</h2>
                <p class="status">
                    {% if project.is_private %}
                        приватный
                    {% else %}
                        публичный
                    {% endif %}
                </p>
            </div>
            
        </div>
        <div class="project_nav">
            <a href="{% url 'project' project.autor.username project.name %}" class="current_nav">Проект</a>
            <a href="">Файлы</a>
            {% if project.autor == request.user %}
                <a href="">Редактирование</a>
            {% endif %}
            <a class="last_nav"></a>
        </div>
        
        <section class="main_project_slider">
            <div class="carousel slide" data-bs-ride="carousel">
                <div id="slider" class="slider carousel-inner">
                    <div class="carousel-item active" data-bs-interval="2000">
                        <img src="/media/{{ project.files.all.0.file }}" class="d-block">
                    </div>
                    {% for photo in project.files.all|slice:"1:" %}
                        <div class="carousel-item" data-bs-interval="4000">
                            <img src="/media/{{ photo.file }}" class="d-block">
                        </div>
                    {% endfor %}
                </div>
            </div>
            <div class="proj_description">
                <p class="name">{{ project.name }}</p>
                <p class="date">Дата публикации: {{ project.created_date }}</p>
                <p class="desc">{{ project.description }}</p>
            </div>
            <div class="project_buttons">
                {% if project.autor == user %}
                    <a class="{% if not project.is_pinned %} unpin_btn {% endif %}" id="pin">
                        <i class="{% if project.is_pinned %}fa-solid bm_checked{% else %} fa-regular bm{% endif %} fa-bookmark " id="pin_i"></i>
                        <p id="pin_text">
                            {% if project.is_pinned %}
                                Открепить
                            {% else %}
                                Закрепить
                            {% endif %}
                        </p>
                    </a>
                {% else %}
                    <a class="{% if not project in user.profile.liked_projects.all %} unlike_btn {% endif %}" id="like">
                        <i class="{% if project in user.profile.liked_projects.all %} fa-solid heart_cheked {% else %} fa-regular {% endif %} fa-heart " id="like_i"></i>
                        <p id="like_text">
                            {% if project in user.profile.liked_projects.all %}
                                Убрать из понравившихся
                            {% else %}
                                Добавить в понравившиеся
                            {% endif %}
                        </p>
                    </a>
                {% endif %}
            </div>
        </section>

        <section class="project_comment_add">
            <h2 class="block_zag">Оставьте свой комментарий</h2>
            <form action="" method="POST">
                {% csrf_token %}
                {{ comment_form.text }}
                <input type="submit">
            </form>
        </section>
        <section class="project_comments">
            {% for com in project.comments.all %}

            <p>{{ com.text }}</p>
            {% endfor %}
        </section>
    </main>

    <!-- Скрипты для ajax запросов -->
    <script>
        $(document).ready(function() {
            // Обработка закрепления и открепления проекта
            $('#pin').on("click", function(event){
                event.preventDefault();
                $.ajax({
                    url: "/project_ajax/",
                    type: "POST",
                    data: {
                        'autor_name': '{{ project.autor.username }}',
                        'project_name': '{{ project.name }}',
                        'action': $('#pin').hasClass("unpin_btn")?'pin':'unpin',
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        $('#pin_text').text(response.text);  // Update the page dynamically
                        if (!$('#pin').hasClass("unpin_btn")){
                            $('#pin').addClass("unpin_btn");
                            $('#pin_i').removeClass("bm_checked");
                            $('#pin_i').removeClass("fa-solid");
                            $('#pin_i').addClass("fa-regular");
                        } else {
                            $('#pin').removeClass("unpin_btn");
                            $('#pin_i').addClass("bm_checked");
                            $('#pin_i').removeClass("fa-regular");
                            $('#pin_i').addClass("fa-solid");
                        }
                        $('#pin_i').addClass("bm");
                    }
                });
            });

           

        });
    </script>
{% endblock %}

